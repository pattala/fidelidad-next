 rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isOwnerCliente(clienteId) {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(clienteId)).data.authUID == request.auth.uid;
    }

    // PUBLIC: heatmap
    match /public_heatmap/{uid} {
      allow read: if true;
      allow write: if isSignedIn()
                   && request.auth.uid == uid
                   && (request.resource.data.lat3 is number)
                   && (request.resource.data.lng3 is number)
                   && (request.resource.data.lat3 >= -90 && request.resource.data.lat3 <= 90)
                   && (request.resource.data.lng3 >= -180 && request.resource.data.lng3 <= 180)
                   && (
                        !request.resource.data.keys().hasAny(['capturedAt']) ||
                        request.resource.data.capturedAt is string ||
                        request.resource.data.capturedAt is timestamp
                      )
                   && (
                        !request.resource.data.keys().hasAny(['rounded']) ||
                        request.resource.data.rounded is bool
                      )
                   && (
                        !request.resource.data.keys().hasAny(['source']) ||
                        request.resource.data.source is string
                      )
                   && (
                        !request.resource.data.keys().hasAny(['name']) ||
                        request.resource.data.name is string
                      )
                   && (
                        !request.resource.data.keys().hasAny(['uid']) ||
                        request.resource.data.uid is string
                      );
    }

    // PUBLIC: recorrido opcional
    match /public_geo/{uid} {
      allow read: if true;
      match /samples/{docId} {
        allow read: if true;
        allow create: if isSignedIn()
                      && request.auth.uid == uid
                      && (request.resource.data.lat3 is number)
                      && (request.resource.data.lng3 is number)
                      && (request.resource.data.lat3 >= -90 && request.resource.data.lat3 <= 90)
                      && (request.resource.data.lng3 >= -180 && request.resource.data.lng3 <= 180)
                      && (
                           !request.resource.data.keys().hasAny(['capturedAt']) ||
                           request.resource.data.capturedAt is string ||
                           request.resource.data.capturedAt is timestamp
                         );
        allow update, delete: if false;
      }
    }

    // CATÁLOGOS
    match /campanas/{id} { 
      allow read: if true;
      allow write: if isAdmin();
    }
    match /premios/{id}  { 
      allow read: if true; 
      allow write: if isAdmin();
    }

    // Bonos (admin)
    match /bonos/{id} {
      allow read, write: if isAdmin();
    }

    // Configuración (usuarios logueados leen; admin escribe)
    // Legacy: configuracion
    // Legacy: configuracion
    match /configuracion/{docId} {
      allow read: if true; // Public parameters (cooldowns, points config)
      allow write: if isAdmin();
    }
    // New: config
    match /config/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Plantillas (admin)
    match /plantillas_mensajes/{docId} {
      allow read, write: if isAdmin();
    }

    // CLIENTES
    match /users/{clienteId} {
      // ✅ Permitir crear: el propio (PWA) o cualquiera si es admin (panel)
      allow create: if
        isAdmin() ||
        (isSignedIn() && request.auth.uid == clienteId);

      // Leer/actualizar/borrar: dueñ@ o admin
      allow read, update, delete: if
        isAdmin() ||
        (isSignedIn() && request.auth.uid == clienteId);

      // Inbox
      match /inbox/{docId} {
        allow read, write: if isAdmin() || (isSignedIn() && request.auth.uid == clienteId);
      }

      // Otras subcolecciones
      match /{sub=**}/{doc} {
        allow read, write: if isAdmin() || (isSignedIn() && request.auth.uid == clienteId);
      }
    }
  }
}
