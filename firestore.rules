  rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'pablo_attala@yahoo.com.ar') ||
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'admin@admin.com') ||
        request.auth.token.admin == true ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    function isEditor() {
      return isAdmin() && (
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'pablo_attala@yahoo.com.ar') ||
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'admin@admin.com') ||
        (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role != 'viewer') ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    function isOwnerCliente(clienteId) {
      return isSignedIn() &&
             get(/databases/$(database)/documents/users/$(clienteId)).data.authUID == request.auth.uid;
    }

    // PUBLIC: heatmap
    match /public_heatmap/{uid} {
      allow read: if true;
      allow write: if isSignedIn()
                   && request.auth.uid == uid
                   && (request.resource.data.lat3 is number)
                   && (request.resource.data.lng3 is number)
                   && (request.resource.data.lat3 >= -90 && request.resource.data.lat3 <= 90)
                   && (request.resource.data.lng3 >= -180 && request.resource.data.lng3 <= 180)
                   && (
                        !request.resource.data.keys().hasAny(['capturedAt']) ||
                        request.resource.data.capturedAt is string ||
                        request.resource.data.capturedAt is timestamp
                      )
                   && (
                        !request.resource.data.keys().hasAny(['rounded']) ||
                        request.resource.data.rounded is bool
                      )
                   && (
                        !request.resource.data.keys().hasAny(['source']) ||
                        request.resource.data.source is string
                      )
                   && (
                        !request.resource.data.keys().hasAny(['name']) ||
                        request.resource.data.name is string
                      )
                   && (
                        !request.resource.data.keys().hasAny(['uid']) ||
                        request.resource.data.uid is string
                      );
    }

    // PUBLIC: recorrido opcional
    match /public_geo/{uid} {
      allow read: if true;
      match /samples/{docId} {
        allow read: if true;
        allow create: if isSignedIn()
                      && request.auth.uid == uid
                      && (request.resource.data.lat3 is number)
                      && (request.resource.data.lng3 is number)
                      && (request.resource.data.lat3 >= -90 && request.resource.data.lat3 <= 90)
                      && (request.resource.data.lng3 >= -180 && request.resource.data.lng3 <= 180)
                      && (
                           !request.resource.data.keys().hasAny(['capturedAt']) ||
                           request.resource.data.capturedAt is string ||
                           request.resource.data.capturedAt is timestamp
                         );
        allow update, delete: if false;
      }
    }

    // CATÁLOGOS
    match /campanas/{id} { 
      allow read: if isAdmin();
      allow write: if isEditor();
    }
    // Suporting both Spanish (legacy/rules) and English (code) names
    match /premios/{id}  { 
      allow read: if true; 
      allow write: if isEditor();
    }
    match /prizes/{id}  { 
      allow read: if true; 
      allow write: if isEditor();
    }

    // Bonos (admin)
    match /bonos/{id} {
      allow read: if isAdmin();
      allow write: if isEditor();
    }

    // Configuración (usuarios logueados leen; admin escribe)
    match /configuracion/{docId} {
      allow read: if true; 
      allow write: if isEditor();
    }
    match /config/general {
      allow read: if true;
      allow write: if isEditor();
    }
    match /config/{docId} {
      allow read: if isSignedIn();
      allow write: if isEditor();
    }

    // Plantillas (admin)
    match /plantillas_mensajes/{docId} {
      allow read: if isAdmin();
      allow write: if isEditor();
    }

    // CLIENTES
    match /users/{clienteId} {
      allow create: if
        isEditor() ||
        (isSignedIn() && request.auth.uid == clienteId);

      allow list: if true;

      allow read, update, delete: if
        isAdmin() && (
          isEditor() ||
          (isSignedIn() && request.auth.uid == clienteId)
        );

      match /inbox/{docId} {
        allow read: if isAdmin() || (isSignedIn() && request.auth.uid == clienteId);
        allow write: if isEditor();
      }

      match /{sub=**}/{doc} {
        allow read: if isAdmin() || (isSignedIn() && request.auth.uid == clienteId);
        allow write: if isEditor();
      }
    }

    // LISTADO DE ADMINISTRADORES
    match /admins/{adminId} {
      allow read: if isSignedIn() && (request.auth.uid == adminId || isAdmin());
      allow write: if isEditor();
      allow list: if isAdmin(); 
    }

    // REGLAS PARA COLLECTION GROUPS
    match /{path=**}/points_history/{docId} {
      allow read: if isAdmin();
    }
    match /{path=**}/visit_history/{docId} {
      allow read: if isAdmin();
    }
  }
}
