rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // FUNCIONES DE APOYO
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'admin') ||
        request.auth.token.email.matches('.*@admin\\.com') ||
        request.auth.token.email == 'pablo_attala@yahoo.com.ar'
      );
    }

    function isEditor() {
      return isSignedIn() && (
        isAdmin() || 
        (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'editor')
      );
    }

    // REGLAS PARA USUARIOS (CLIENTES)
    match /users/{userId} {
      // El admin lee/escribe todo, el usuario solo su propio perfil
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      
      // Permitir la búsqueda por email para la migración de login (limit 1)
      allow list: if (request.query.limit <= 1); 

      allow create: if isSignedIn() && request.auth.uid == userId; // Solo el usuario se crea a sí mismo
      allow update: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow delete: if isAdmin();

      // Inbox (Para la campanita de la PWA)
      match /inbox/{msgId} {
        // El usuario puede leer, marcar como leído (update) y borrar sus mensajes
        // Se permite 'create' para que la PWA pueda auto-mandarse mensajes de bienvenida/sistema localmente
        allow read, update, delete, create: if isSignedIn() && request.auth.uid == userId; 
        allow create: if isAdmin(); // El admin también puede crear mensajes para el usuario
      }
      
      // Historial de Puntos
      match /points_history/{docId} {
        allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
        allow write: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      }

      // Historial de Visitas / Actividad
      match /visit_history/{docId} {
        allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
        allow create: if isSignedIn() && request.auth.uid == userId;
        allow update, delete: if isAdmin();
      }
    }

    // CONFIGURACIÓN GLOBAL
    match /config/{document} {
      allow read: if true; // Público para que la PWA cargue logo/colores
      allow write: if isAdmin();
    }

    // PRODUCTOS Y PREMIOS
    match /prizes/{prizeId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // COLECCION PARA CATALOGO DE PREMIOS (LEGACY O ALIAS)
    match /prizes_catalog/{id} {
        allow read: if true;
    }

    // CAMPAÑAS Y PROMOS (IMPORTANTE: Colección se llama 'campanas')
    match /campanas/{campaignId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // CANJES (REDEMPTIONS)
    match /redemptions/{id} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == resource.data.clientId);
      allow create: if isAdmin() || isSignedIn();
      allow update, delete: if isAdmin();
    }

    // COLECCIÓN DE ADMINISTRADORES
    match /admins/{adminId} {
      allow read: if isSignedIn();
      allow list: if isSignedIn() || (request.query.limit <= 1); // Permitir check de existencia inicial
      allow write: if isAdmin();
    }

    // GEOLOCALIZACIÓN Y MAPAS
    match /public_geo/{uid} {
      allow read: if true;
      match /samples/{docId} {
        allow read: if true;
        allow create: if isSignedIn() && request.auth.uid == uid;
      }
    }
    
    // REGLA PARA BUSQUEDAS DE POINT HISTORY (Admin Panel)
    match /{path=**}/points_history/{docId} {
      allow read: if isAdmin();
    }
    
    match /{path=**}/visit_history/{docId} {
      allow read: if isAdmin();
    }
  }
}
