rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() && (
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'pablo_attala@yahoo.com.ar') ||
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'admin@admin.com') ||
        request.auth.token.admin == true ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    function isEditor() {
      return isAdmin() && (
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'pablo_attala@yahoo.com.ar') ||
        (request.auth.token.email != null && request.auth.token.email.toLower() == 'admin@admin.com') ||
        (exists(/databases/$(database)/documents/admins/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role != 'viewer') ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // CATÁLOGOS - PÚBLICOS
    match /campanas/{id} { 
      allow read: if true;
      allow write: if isEditor();
    }
    match /premios/{id}  { 
      allow read: if true; 
      allow write: if isEditor();
    }
    match /prizes/{id}  { 
      allow read: if true; 
      allow write: if isEditor();
    }

    // Configuración (Pública para Branding/Logos)
    match /configuracion/{docId} {
      allow read: if true; 
      allow write: if isEditor();
    }
    match /config/general {
      allow read: if true;
      allow write: if isEditor();
    }
    match /config/{docId} {
      allow read: if true; // Permitir lectura de config general para branding
      allow write: if isEditor();
    }
    
    // Plantillas (admin)
    match /plantillas_mensajes/{docId} {
      allow read: if isAdmin();
      allow write: if isEditor();
    }

    // CLIENTES
    match /users/{clienteId} {
      // Necesario para que el cliente cree su propio perfil al registrarse
      allow create: if
        isEditor() ||
        (isSignedIn() && request.auth.uid == clienteId);

      // Necesario para validar unicidad de DNI o Teléfono durante el registro
      allow list: if true;

      // El usuario puede leer y modificar su propio perfil. Admin puede todo.
      allow read, update: if
        isAdmin() || (isSignedIn() && request.auth.uid == clienteId);
      
      allow delete: if isAdmin();

      // Subcolecciones del usuario (historial, inbox, etc)
      match /{sub=**}/{doc} {
        allow read: if isAdmin() || (isSignedIn() && request.auth.uid == clienteId);
        allow write: if isAdmin() || isEditor() || (isSignedIn() && request.auth.uid == clienteId);
      }
    }

    // ADMINISTRADORES
    match /admins/{adminId} {
      allow read: if isSignedIn() && (request.auth.uid == adminId || isAdmin());
      allow write: if isEditor();
      allow list: if isAdmin(); 
    }

    // REGLAS PARA COLLECTION GROUPS
    match /{path=**}/points_history/{docId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid in path);
    }
    match /{path=**}/visit_history/{docId} {
      allow read: if isAdmin();
    }

    // REGLAS PÚBLICAS DE MAPAS / GEOLOC (si se usan)
    match /public_heatmap/{uid} { allow read: if true; allow write: if isSignedIn() && request.auth.uid == uid; }
    match /public_geo/{uid} { allow read: if true; match /samples/{docId} { allow read: if true; allow create: if isSignedIn() && request.auth.uid == uid; } }

  }
}
